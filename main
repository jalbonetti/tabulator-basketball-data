// main.js - Basketball Props Table System
import { injectStyles } from './styles/tableStyles.js';
import { BasketPlayerPropClearancesTable } from './tables/basketPlayerPropClearances.js';

// Global state for expanded rows
window.globalExpandedState = window.globalExpandedState || new Map();

document.addEventListener("DOMContentLoaded", function() {
    console.log("DOM loaded - initializing basketball table system");
    
    // Inject styles first
    injectStyles();
    
    // Initialize global state management
    initializeGlobalState();
    
    // Find the table element
    const tableElement = document.getElementById('basketball-table');
    if (!tableElement) {
        console.log("No basketball-table element found - looking for alternate IDs...");
        // Try alternate element IDs
        const altElement = document.getElementById('player-props-table') || 
                          document.getElementById('clearances-table') ||
                          document.getElementById('batter-table'); // fallback to existing ID if reusing
        
        if (!altElement) {
            console.error("No table element found - cannot initialize");
            return;
        }
        
        console.log("Found alternate table element:", altElement.id);
        initializeTable('#' + altElement.id);
    } else {
        initializeTable('#basketball-table');
    }
});

function initializeTable(elementId) {
    try {
        console.log("Initializing basketball clearances table...");
        
        const table = new BasketPlayerPropClearancesTable(elementId);
        table.initialize();
        
        // Store reference globally for debugging
        window.basketballTable = table;
        
        console.log("✅ Basketball table initialized successfully!");
        
    } catch (error) {
        console.error("❌ Error initializing basketball table:", error);
    }
}

function initializeGlobalState() {
    // Ensure global state exists
    if (!window.globalExpandedState) {
        window.globalExpandedState = new Map();
    }
    
    // Add state persistence helpers
    window.saveExpandedState = function(tableId, rowId, expanded) {
        const key = `${tableId}_${rowId}`;
        if (expanded) {
            window.globalExpandedState.set(key, true);
        } else {
            window.globalExpandedState.delete(key);
        }
    };
    
    window.getExpandedState = function(tableId, rowId) {
        const key = `${tableId}_${rowId}`;
        return window.globalExpandedState.get(key) || false;
    };
    
    console.log("Global state management initialized");
}

// Handle window resize
window.addEventListener('resize', function() {
    if (window.basketballTable && window.basketballTable.table) {
        window.basketballTable.table.redraw();
    }
});

// Global error handler
window.addEventListener('error', function(e) {
    console.error('Global error in basketball table system:', e.error);
});

// Export for debugging
window.tableDebug = {
    getGlobalState: () => window.globalExpandedState,
    clearGlobalState: () => {
        window.globalExpandedState.clear();
        console.log("Global state cleared");
    },
    logState: () => {
        console.log("Current global state:", Array.from(window.globalExpandedState.entries()));
    },
    getTable: () => window.basketballTable
};

console.log("✅ Basketball table system loaded");
